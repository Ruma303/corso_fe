<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rubrica</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
    crossorigin="anonymous"></script>

  <style>
    .removable-field {
      position: relative;
    }

    .remove-btn {
      position: absolute;
      top: 0;
      right: 0;
      z-index: 1;
    }
  </style>
</head>

<body class="p-4">
  <div class="container">
    <h1 class="mb-4">Rubrica</h1>
    <button class="btn btn-info mb-3" id="toggleForm">Nuovo Contatto</button>

    <div id="contactList" class="mb-4"></div>

    <form id="contactForm" class="d-none">
      <div class="mb-3">
        <label for="nome" class="form-label">Nome</label>
        <input type="text" id="nome" class="form-control" name="nome" />
      </div>
      <div class="mb-3">
        <label for="cognome" class="form-label">Cognome</label>
        <input type="text" id="cognome" class="form-control" name="cognome" />
      </div>
      <div class="mb-3">
        <label for="anni" class="form-label">Anni</label>
        <input type="number" id="anni" class="form-control" name="anni" />
      </div>
      <div class="mb-3">
        <label for="email" class="form-label">Email</label>
        <input type="email" id="email" class="form-control" name="email" />
      </div>

      <div id="extraFields"></div>

      <div class="mb-3">
        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal"
          data-bs-target="#addFieldModal">Aggiungi Campo</button>
      </div>

      <button type="submit" id="salva" class="btn btn-success">Salva</button>
    </form>
  </div>

  <!-- Modal per aggiungere campo dinamico -->
  <div class="modal fade" id="addFieldModal" tabindex="-1" aria-labelledby="addFieldModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Aggiungi Campo Dinamico</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="newFieldLabel" class="form-label">Nome campo</label>
            <input type="text" id="newFieldLabel" class="form-control" placeholder="Es: Telefono" />
          </div>
          <div class="mb-3">
            <label for="newFieldType" class="form-label">Tipo di dato</label>
            <select id="newFieldType" class="form-select">
              <option value="text">Testo</option>
              <option value="number">Numero</option>
              <option value="email">Email</option>
              <option value="date">Data</option>
              <option value="tel">Telefono</option>
              <option value="url">URL</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="newFieldName" class="form-label">Valore</label>
            <input type="text" id="newFieldName" class="form-control" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
          <button type="button" class="btn btn-primary" id="addField">Aggiungi</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal per aggiornare campo -->
  <div class="modal fade" id="updateFieldModal" tabindex="-1" aria-labelledby="updateFieldModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="updateFieldForm">
          <div class="modal-header">
            <h5 class="modal-title" id="updateFieldModalLabel">Aggiorna Campo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Etichetta campo</label>
              <input type="text" id="updateFieldLabel" class="form-control" readonly />
            </div>
            <div class="mb-3">
              <label class="form-label">Tipo</label>
              <select id="updateFieldType" class="form-select">
                <option value="text">Testo</option>
                <option value="number">Numero</option>
                <option value="email">Email</option>
                <option value="date">Data</option>
                <option value="tel">Telefono</option>
                <option value="url">URL</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="updateFieldValue" class="form-label">Valore</label>
              <input type="text" id="updateFieldValue" class="form-control" />
            </div>
            <input type="hidden" id="updateKey" />
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            <button type="submit" class="btn btn-primary">Salva Modifica</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Conferma Eliminazione -->
  <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteConfirmModalLabel">Conferma eliminazione</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
          Sei sicuro di voler eliminare questo contatto?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Elimina</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.querySelector("#contactForm");
    const contactList = document.querySelector("#contactList");
    const toggleFormBtn = document.querySelector("#toggleForm");
    const extraFieldsContainer = document.querySelector("#extraFields");
    const addFieldBtn = document.querySelector("#addField");
    const newFieldNameInput = document.querySelector("#newFieldName");
    const newFieldLabelInput = document.querySelector("#newFieldLabel");
    const newFieldTypeSelect = document.querySelector("#newFieldType");

    const updateModal = new bootstrap.Modal(document.querySelector('#updateFieldModal'));
    const uLabel = document.querySelector('#updateFieldLabel');
    const uType = document.querySelector('#updateFieldType');
    const uValue = document.querySelector('#updateFieldValue');
    const uKey = document.querySelector('#updateKey');
    const updateForm = document.querySelector('#updateFieldForm');

    const deleteModal = new bootstrap.Modal(document.querySelector('#deleteConfirmModal'));
    const confirmDeleteBtn = document.querySelector("#confirmDeleteBtn");
    let keyToDelete = null;

    // Toggle form/list
    toggleFormBtn.addEventListener("click", () => {
      form.classList.toggle("d-none");
      contactList.classList.toggle("d-none");
    });

    // Aggiungi campo dinamico nel form
    addFieldBtn.addEventListener("click", () => {
      const label = newFieldLabelInput.value.trim();
      if (!label) return;
      const type = newFieldTypeSelect.value;
      const id = `field-${label.replace(/\s+/g, '-').toLowerCase()}`;
      const wrapper = document.createElement("div");
      wrapper.className = "mb-3 removable-field";
      wrapper.innerHTML = `
      <label for="${id}" class="form-label">${label}</label>
      <input type="${type}" class="form-control" name="${label}" id="${id}" value="${newFieldNameInput.value.trim()}">
      <button type="button" class="btn btn-sm btn-danger remove-btn mt-1">Elimina</button>`;
      extraFieldsContainer.appendChild(wrapper);
      wrapper.querySelector(".remove-btn").onclick = () => wrapper.remove();
      newFieldLabelInput.value = "";
      newFieldNameInput.value = "";
      newFieldTypeSelect.value = "text";
      newFieldNameInput.type = "text";
      bootstrap.Modal.getInstance(document.getElementById('addFieldModal')).hide();
    });

    // Salva nuovo contatto in localStorage
    form.addEventListener("submit", e => {
      e.preventDefault();
      const nome = form.nome.value.trim();
      if (!nome) { alert("Nome obbligatorio"); return; }
      const data = {
        nome: nome,
        cognome: form.cognome.value.trim(),
        email: form.email.value.trim(),
        anni: form.anni.value.trim()
      };
      // campi extra
      extraFieldsContainer.querySelectorAll("input").forEach(input => {
        const lbl = input.previousElementSibling.textContent.trim();
        data[lbl] = input.value;
      });
      localStorage.setItem(nome, JSON.stringify(data));
      form.reset();
      extraFieldsContainer.innerHTML = "";
      form.classList.add("d-none");
      contactList.classList.remove("d-none");
      render();
    });

    // Render di tutti i contatti
    function render() {
      contactList.innerHTML = "";
      const keys = Object.keys(localStorage);
      if (keys.length === 0) {
        contactList.textContent = "Nessun contatto salvato.";
        return;
      }
      keys.forEach(key => {
        const data = JSON.parse(localStorage.getItem(key));
        const card = document.createElement("div");
        card.className = "card mb-2";
        const body = document.createElement("div");
        body.className = "card-body";
        body.innerHTML = `<h5 class="card-title">${data.nome} ${data.cognome}</h5>`;
        Object.entries(data).forEach(([field, val]) => {
          if (["nome", "cognome"].includes(field)) return;
          const p = document.createElement("p");
          p.className = "card-text mb-1";
          p.innerHTML = `<strong>${field}:</strong>
          <span id="val-${key}-${field}">${val}</span>
          <button class="btn btn-warning btn-sm ms-2" data-key="${key}" data-field="${field}">Aggiorna</button>`;
          body.appendChild(p);
        });
        const del = document.createElement("button");
        del.className = "btn btn-danger btn-sm mt-2";
        del.textContent = "Elimina Contatto";
        del.setAttribute("data-key", key);
        del.setAttribute("data-bs-toggle", "modal");
        del.setAttribute("data-bs-target", "#deleteConfirmModal");
        body.appendChild(del);
        card.appendChild(body);
        contactList.appendChild(card);
      });

      // Aggiorna
      contactList.querySelectorAll("button[data-field]").forEach(btn => {
        btn.onclick = e => {
          const key = e.target.dataset.key;
          const field = e.target.dataset.field;
          const data = JSON.parse(localStorage.getItem(key));
          uLabel.value = field;
          uType.value = getType(data[field]);
          uValue.type = uType.value;
          uValue.value = data[field];
          uKey.value = key;
          uValue.dataset.field = field;
          updateModal.show();
        };
      });

      // Elimina
      contactList.querySelectorAll("button[data-bs-target='#deleteConfirmModal']").forEach(btn => {
        btn.onclick = e => keyToDelete = e.target.dataset.key;
      });
    }

    function getType(val) {
      if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return "date";
      if (!isNaN(val)) return "number";
      return "text";
    }

    // Submit modale Aggiorna
    updateForm.addEventListener("submit", e => {
      e.preventDefault();
      const key = uKey.value;
      const field = uValue.dataset.field;
      const data = JSON.parse(localStorage.getItem(key));
      data[field] = uValue.value.trim();
      localStorage.setItem(key, JSON.stringify(data));
      updateModal.hide();
      render();
    });

    // Conferma Eliminazione
    confirmDeleteBtn.addEventListener("click", () => {
      if (keyToDelete) {
        localStorage.removeItem(keyToDelete);
        keyToDelete = null;
        deleteModal.hide();
        render();
      }
    });

    // Inizializza
    render();
  </script>

</body>

</html>