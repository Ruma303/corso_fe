<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rubrica</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
    crossorigin="anonymous"></script>

  <style>
    .removable-field {
      position: relative;
    }

    .remove-btn {
      position: absolute;
      top: 0;
      right: 0;
      z-index: 1;
    }
  </style>
</head>

<body class="p-4">
  <div class="container">
    <h1 class="mb-4">Rubrica</h1>
    <button class="btn btn-info mb-3" id="toggleForm">Nuovo Contatto</button>

    <div id="contactList" class="mb-4"></div>

    <form id="contactForm" class="d-none">
      <div class="mb-3">
        <label for="nome" class="form-label">Nome</label>
        <input type="text" id="nome" class="form-control" name="nome" />
      </div>
      <div class="mb-3">
        <label for="cognome" class="form-label">Cognome</label>
        <input type="text" id="cognome" class="form-control" name="cognome" />
      </div>
      <div class="mb-3">
        <label for="anni" class="form-label">Anni</label>
        <input type="number" id="anni" class="form-control" name="anni" />
      </div>
      <div class="mb-3">
        <label for="email" class="form-label">Email</label>
        <input type="email" id="email" class="form-control" name="email" />
      </div>

      <div id="extraFields"></div>

      <div class="mb-3">
        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal"
          data-bs-target="#addFieldModal">Aggiungi Campo</button>
      </div>

      <button type="submit" id="salva" class="btn btn-success">Salva</button>
    </form>
  </div>

  <!-- Modal per aggiungere campo dinamico -->
  <div class="modal fade" id="addFieldModal" tabindex="-1" aria-labelledby="addFieldModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Aggiungi Campo Dinamico</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="newFieldLabel" class="form-label">Nome campo</label>
            <input type="text" id="newFieldLabel" class="form-control" placeholder="Es: Telefono" />
          </div>
          <div class="mb-3">
            <label for="newFieldType" class="form-label">Tipo di dato</label>
            <select id="newFieldType" class="form-select">
              <option value="text">Testo</option>
              <option value="number">Numero</option>
              <option value="email">Email</option>
              <option value="date">Data</option>
              <option value="tel">Telefono</option>
              <option value="url">URL</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="newFieldName" class="form-label">Valore</label>
            <input type="text" id="newFieldName" class="form-control" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
          <button type="button" class="btn btn-primary" id="addField">Aggiungi</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    const form = document.querySelector("#contactForm");
    const contactList = document.querySelector("#contactList");
    const toggleFormBtn = document.querySelector("#toggleForm");
    const extraFieldsContainer = document.querySelector("#extraFields");
    const addFieldBtn = document.querySelector("#addField");
    const newFieldNameInput = document.querySelector("#newFieldName");
    const newFieldLabelInput = document.querySelector("#newFieldLabel");
    const newFieldTypeSelect = document.querySelector("#newFieldType");

    // Modifica dinamicamente il type dell'input del nome campo
    newFieldTypeSelect.addEventListener("change", () => {
      const selectedType = newFieldTypeSelect.value;
      newFieldNameInput.setAttribute("type", selectedType);
    });

    toggleFormBtn.addEventListener("click", () => {
      form.classList.toggle("d-none");
      contactList.classList.toggle("d-none");
    });

    addFieldBtn.addEventListener("click", () => {
      const fieldLabel = newFieldLabelInput.value.trim();
      const fieldValue = newFieldNameInput.value.trim();
      const fieldType = newFieldTypeSelect.value;

      if (!fieldLabel || !fieldType) return;

      const fieldId = `field-${fieldLabel.toLowerCase().replace(/\s+/g, '-')}`;

      const wrapper = document.createElement("div");
      wrapper.classList.add("mb-3", "removable-field");

      wrapper.innerHTML = `
    <label for="${fieldId}" class="form-label">${fieldLabel}</label>
    <input type="${fieldType}" class="form-control" name="${fieldId}" id="${fieldId}" value="${fieldValue}" />
    <button type="button" class="btn btn-sm btn-danger remove-btn">X</button>
  `;

      extraFieldsContainer.appendChild(wrapper);

      wrapper.querySelector(".remove-btn").addEventListener("click", () => {
        wrapper.remove();
      });

      // Reset campi del modale
      newFieldLabelInput.value = '';
      newFieldNameInput.value = '';
      newFieldTypeSelect.value = 'text';
      newFieldNameInput.setAttribute("type", 'text');

      const modal = bootstrap.Modal.getInstance(document.querySelector('#addFieldModal'));
      modal.hide();
    });

    newFieldTypeSelect.addEventListener("change", () => {
      const selectedType = newFieldTypeSelect.value;
      newFieldNameInput.setAttribute("type", selectedType);
    });

    form.addEventListener("submit", function (e) {
      e.preventDefault();

      const nome = document.querySelector("#nome").value.trim();
      const cognome = document.querySelector("#cognome").value.trim();
      const email = document.querySelector("#email").value.trim();
      const anni = document.querySelector("#anni").value.trim();

      if (!nome || !cognome || !email || !anni) {
        alert("Inserisci tutti i dati obbligatori!");
        return;
      }

      const data = {
        nome,
        cognome,
        email,
        anni
      };

      // Raccoglie tutti i campi dinamici: name â†’ value
      const extraInputs = extraFieldsContainer.querySelectorAll("input");
      extraInputs.forEach(input => {
        const label = input.previousElementSibling;
        const fieldLabel = label ? label.textContent.trim() : input.name;
        data[fieldLabel] = input.value;
      });

      localStorage.setItem(nome, JSON.stringify(data));
      form.reset();
      extraFieldsContainer.innerHTML = '';
      form.classList.add("d-none");
      contactList.classList.remove("d-none");
      mostraContatti();
    });

    function mostraContatti() {
      contactList.innerHTML = "";

      const keys = Object.keys(localStorage);
      if (keys.length === 0) {
        contactList.textContent = "Nessun contatto salvato.";
        return;
      }

      keys.forEach(key => {
        const data = JSON.parse(localStorage.getItem(key));
        const div = document.createElement("div");
        div.classList.add("border", "p-2", "mb-2", "rounded", "bg-light");

        const lista = Object.entries(data).map(([k, v]) => `<strong>${k}:</strong> ${v}`).join("<br>");
        div.innerHTML = lista;
        contactList.appendChild(div);
      });

      const btn = document.createElement("button");
      btn.textContent = "Cancella tutti i contatti";
      btn.className = "btn btn-danger mt-2";
      btn.addEventListener("click", () => {
        localStorage.clear();
        mostraContatti();
      });
      contactList.appendChild(btn);
    }

    mostraContatti();
  </script>
</body>

</html>